<?php
/**
 * @file
 * Provides functionality for handling webform hook.
 */

/**
 * Implements hook_form_alter().
 */
function ellison_webform_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  echo $form_id. '  -webform-submission-contact-node-45-add-form';
  if (strpos($form_id, 'webform_submission_contact') !== FALSE ||
    strpos($form_id, 'webform_submission_service_and_maintenance') !== FALSE ||
    strpos($form_id, 'webform_submission_parts_and_accessories') !== FALSE
  ) {
    dump($_COOKIE['ellison_region']);
    if (!empty($_COOKIE['ellison_region'])) {
      echo $form_id;
      dump($_COOKIE['ellison_region']);
      $region = json_decode($_COOKIE['ellison_region'], TRUE);
      if (isset($form['elements']['location']) || isset($form['elements']['select_location'])) {
        if (!empty($region['region_id'])) {

          echo $parent_id = $region['region_id'];
          $child_terms = \Drupal::entityTypeManager()
            ->getStorage('taxonomy_term')
            ->loadTree('regions', $parent_id, NULL, FALSE);
          $child_region = [];
          foreach ($child_terms as $term) {
            $child_region[$term->name] = $term->name;
          }
          if (isset($form['elements']['location'])) {
            $form['elements']['location']['#options'] = $child_region;
          }
          elseif (isset($form['elements']['select_location'])) {
            //dump($form['elements']['select_location']);
            $form['elements']['select_location']['#options'] = $child_region;
          }
        }
      }
    }
  }
}
